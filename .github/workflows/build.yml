name: Build and Release

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

env:
  DOTNET_VERSION: '8.0.x'
  VPK_VERSION: '0.0.626'

jobs:
  build-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install Velopack CLI
        run: dotnet tool install -g vpk --version ${{ env.VPK_VERSION }}

      - name: Get version
        id: version
        shell: pwsh
        run: |
          if ("${{ github.ref }}" -match "refs/tags/v(.+)") {
            $version = $matches[1]
          } else {
            $version = "0.0.1-dev.${{ github.run_number }}"
          }
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "Version: $version"

      - name: Restore dependencies
        run: dotnet restore src/Canopy.Windows/Canopy.Windows.csproj

      - name: Publish
        run: |
          dotnet publish src/Canopy.Windows/Canopy.Windows.csproj `
            -c Release `
            -r win-x64 `
            -o dist/publish `
            --self-contained true `
            -p:Version=${{ steps.version.outputs.VERSION }} `
            -p:DebugType=none `
            -p:DebugSymbols=false

      - name: Create Velopack installer
        shell: pwsh
        run: |
          $vpkArgs = @(
            "pack",
            "-u", "Canopy",
            "-v", "${{ steps.version.outputs.VERSION }}",
            "-p", "dist/publish",
            "-e", "Canopy.Windows.exe",
            "-o", "dist/releases",
            "-c", "win",
            "--packTitle", "Canopy",
            "--packAuthors", "Canopy"
          )
          if (Test-Path "src/Canopy.Windows/Assets/canopy.ico") {
            $vpkArgs += @("-i", "src/Canopy.Windows/Assets/canopy.ico")
          }
          & vpk @vpkArgs

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: Canopy-win-x64-installer
          path: dist/releases/*

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Install Velopack CLI
        run: dotnet tool install -g vpk --version ${{ env.VPK_VERSION }}

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" =~ refs/tags/v(.+) ]]; then
            VERSION="${BASH_REMATCH[1]}"
          else
            VERSION="0.0.1-dev.${{ github.run_number }}"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Restore dependencies
        run: dotnet restore src/Canopy.Linux/Canopy.Linux.csproj

      - name: Publish
        run: |
          dotnet publish src/Canopy.Linux/Canopy.Linux.csproj \
            -c Release \
            -r linux-x64 \
            -o dist/publish \
            --self-contained true \
            -p:Version=${{ steps.version.outputs.VERSION }} \
            -p:DebugType=none \
            -p:DebugSymbols=false

      - name: Create Velopack package
        run: |
          vpk pack \
            -u Canopy \
            -v ${{ steps.version.outputs.VERSION }} \
            -p dist/publish \
            -e Canopy.Linux \
            -o dist/releases \
            -c linux \
            --packTitle Canopy \
            --packAuthors Canopy

      - name: Upload installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: Canopy-linux-x64-installer
          path: dist/releases/*

  release:
    needs: [build-windows, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: Canopy-win-x64-installer
          path: artifacts/windows

      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: Canopy-linux-x64-installer
          path: artifacts/linux

      - name: Get version
        id: version
        run: |
          VERSION="${GITHUB_REF#refs/tags/v}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: List artifacts
        run: |
          echo "Windows artifacts:"
          ls -la artifacts/windows/
          echo "Linux artifacts:"
          ls -la artifacts/linux/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Canopy v${{ steps.version.outputs.VERSION }}
          draft: false
          prerelease: ${{ contains(steps.version.outputs.VERSION, '-') }}
          files: |
            artifacts/windows/*
            artifacts/linux/*
          body: |
            ## Canopy v${{ steps.version.outputs.VERSION }}
            
            ### Downloads
            
            | Platform | Download |
            |----------|----------|
            | Windows x64 | `Canopy-win-Setup.exe` |
            | Linux x64 | `Canopy-linux-Portable.zip` |
            
            ### Installation
            
            **Windows:**
            1. Download `Canopy-win-Setup.exe`
            2. Run the installer
            3. Follow the GUI installation wizard
            
            **Linux:**
            1. Download the portable zip or AppImage
            2. Extract and make executable: `chmod +x Canopy.Linux`
            3. Run: `./Canopy.Linux`
            
            ### Auto-Updates
            
            Canopy will automatically check for updates and notify you when a new version is available.
